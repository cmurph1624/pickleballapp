rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null;
    }

    match /channels/{channelId} {
      // Allow read if user is in the allowed list
      allow read: if request.auth != null && request.auth.uid in resource.data.allowedUserIds;
      
      // Allow create only for DMs, and user must be in the list
      allow create: if request.auth != null && 
                   request.resource.data.type == 'dm' &&
                   request.auth.uid in request.resource.data.allowedUserIds;
                   
      // Deny update for Lobbies/Huddles by users (handled by Backend)
      allow update: if false; 

      // Allow delete if:
      // 1. It is a session huddle (contextId in metadata)
      // 2. The session exists
      // 3. User is admin of the club that owns the session
      allow delete: if request.auth != null && 
                       resource.data.type == 'huddle' &&
                       canDeleteSessionChannel();
                       
      function canDeleteSessionChannel() {
        let sessionId = resource.data.metadata.contextId;
        let session = get(/databases/$(database)/documents/sessions/$(sessionId)).data;
        let club = get(/databases/$(database)/documents/clubs/$(session.clubId)).data;
        return request.auth.uid in club.admins;
      }

    match /channels/{channelId}/messages/{messageId} {
       // Function to check parent channel access
       function hasChannelAccess() {
         let channelData = get(/databases/$(database)/documents/channels/$(channelId)).data;
         return request.auth.uid in channelData.allowedUserIds;
       }

       allow read: if request.auth != null && hasChannelAccess();
       allow create: if request.auth != null && hasChannelAccess() && request.resource.data.senderId == request.auth.uid;
    }
  }
}
